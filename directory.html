<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apiculture Directory | Bee Planet Connection</title>
  <meta name="description" content="Browse and filter apiculture organisations, associations, and resources worldwide." />
  <style>
    :root{--paper:#faf7f1;--ink:#333;--line:#e0d7c6}
    html,body{margin:0;background:var(--paper);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{background:#fff8e8;border-bottom:1px solid var(--line);padding:1rem}
    h1{margin:0}
    .filters{display:flex;flex-wrap:wrap;gap:.75rem;padding:1rem;background:#fff;border-bottom:1px solid var(--line)}
    .filters select,.filters input{padding:.55rem .7rem;border:1px solid var(--line);border-radius:10px;background:#fff}
    .filters input{min-width:220px}
    .count{margin-left:auto;color:#6a645a}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;padding:1rem}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:1rem}
    .card h2{margin:.2rem 0 .3rem;font-size:1.05rem}
    .meta{color:#6a645a;font-size:.9rem}
    footer{text-align:center;padding:2rem;color:#6a645a;font-size:.9rem}
  </style>

  <!-- Breadcrumbs (static) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://beeplanetconnection.org/"},
      {"@type":"ListItem","position":2,"name":"Directory","item":"https://beeplanetconnection.org/directory.html"}
    ]
  }
  </script>
</head>
<body>
  <header>
    <h1>Global Apiculture Directory</h1>
    <p class="meta">Browse organisations and resources worldwide</p>
  </header>

  <section class="filters">
    <input id="q" type="search" placeholder="Search name, topics, country…" aria-label="Search directory" />
    <select id="regionFilter"><option value="">All Regions</option></select>
    <select id="countryFilter"><option value="">All Countries</option></select>
    <select id="typeFilter"><option value="">All Types</option></select>
    <select id="scopeFilter"><option value="">All Scopes</option></select>
    <select id="topicFilter"><option value="">All Topics</option></select>
    <span class="count" id="count">—</span>
  </section>

  <main class="cards" id="cards" aria-live="polite"></main>

  <footer>
    Bee Planet Connection © 2025 — Illustrations by E. H. Shepard (Public Domain)
  </footer>

  <script>
    async function loadJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error("Fetch failed: "+url); return r.json(); }

    function uniq(list){
      return [...new Set(list.flatMap(v => Array.isArray(v) ? v : [v]).filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b)));
    }

    function optionize(selectId, values){
      const sel = document.getElementById(selectId);
      values.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    }

    function matches(item, state){
      const blob = (item.name+" "+item.description+" "+item.country+" "+(item.topics||[]).join(" ")).toLowerCase();
      if(state.q && !blob.includes(state.q.toLowerCase())) return false;
      if(state.region && item.region !== state.region) return false;
      if(state.country && item.country !== state.country) return false;
      if(state.type && item.type !== state.type) return false;
      if(state.scope && !(item.scope||[]).includes(state.scope)) return false;
      if(state.topic && !(item.topics||[]).includes(state.topic)) return false;
      return true;
    }

    function cardHTML(item){
      return `
        <article class="card">
          <h2><a href="${item.url}" target="_blank" rel="noopener">${item.name}</a></h2>
          <p class="meta">${item.type} · ${item.country}${item.region && item.region!=='Global' ? ' ('+item.region+')' : ''}</p>
          <p>${item.description || ''}</p>
          <p class="meta"><strong>Scope:</strong> ${(item.scope||[]).join(', ') || '—'}</p>
          <p class="meta"><strong>Topics:</strong> ${(item.topics||[]).join(', ') || '—'}</p>
        </article>
      `;
    }

    // Emit JSON-LD for current results (ItemList + per-item Organization)
    function emitJSONLD(list){
      // ItemList
      const itemList = {
        "@context":"https://schema.org",
        "@type":"ItemList",
        "itemListElement": list.map((it,i)=>({
          "@type":"ListItem",
          "position": i+1,
          "url": it.url
        }))
      };

      // Organizations
      const orgs = list.map(it => ({
        "@context":"https://schema.org",
        "@type":"Organization",
        "name": it.name,
        "url": it.url,
        "areaServed": it.country || it.region || "Global",
        "knowsAbout": (it.topics || []).slice(0,8),
        "description": it.description || undefined
      }));

      // Replace or create tag
      let tag = document.getElementById('ld-results');
      if(!tag){ tag = document.createElement('script'); tag.type='application/ld+json'; tag.id='ld-results'; document.body.appendChild(tag); }
      tag.textContent = JSON.stringify([itemList, ...orgs]);
    }

    (async function init(){
      const data = await loadJSON('./data/directory.seed.json');

      // Build filter options
      optionize('regionFilter',  uniq(data.map(d=>d.region)));
      optionize('countryFilter', uniq(data.map(d=>d.country)));
      optionize('typeFilter',    uniq(data.map(d=>d.type)));
      optionize('scopeFilter',   uniq(data.map(d=>d.scope || [])));
      optionize('topicFilter',   uniq(data.map(d=>d.topics || [])));

      const state = { q:'', region:'', country:'', type:'', scope:'', topic:'' };

      const render = () => {
        const list = data.filter(d => matches(d, state));
        document.getElementById('cards').innerHTML = list.map(cardHTML).join('');
        document.getElementById('count').textContent = `${list.length} result${list.length===1?'':'s'}`;
        emitJSONLD(list);
      };

      // Bind controls
      document.getElementById('q').addEventListener('input', e => { state.q = e.target.value; render(); });
      ['region','country','type','scope','topic'].forEach(key=>{
        document.getElementById(key+'Filter').addEventListener('change', e => { state[key] = e.target.value; render(); });
      });

      render();
    })();
  </script>
</body>
</html>

